<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<link rel="icon" href="https://dummyimage.com/32x32/000/fff.png">
<title>Buscador Ultra â€” Multi-proveedor</title>
<style>
:root{--accent:#0b76f4;--muted:#666}
body{font-family:Inter,Arial,Helvetica,sans-serif;margin:0;background:#f5f7fb;color:#222}
header{background:#fff;padding:18px 24px;box-shadow:0 2px 6px rgba(12,20,30,.06);display:flex;gap:12px;align-items:center;flex-wrap:wrap}
header h1{margin:0;font-size:18px;flex-basis:100%;}
.searchbar{flex:1;display:flex;gap:8px;flex-wrap:wrap}
input[type="search"]{flex:1;padding:12px 14px;border-radius:10px;border:1px solid #e2e8f0;font-size:16px}
select,input[type="number"]{padding:10px;border-radius:8px;border:1px solid #e2e8f0}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
main{padding:18px 24px}
.grid {
  display: grid;
  grid-template-columns: repeat(6, 1fr);
  gap: 14px;
}

/* Pantallas medianas (tablets, aprox 768px) */
@media (max-width: 768px) {
  .grid {
    grid-template-columns: repeat(3, 1fr); /* 3 columnas */
  }
}

/* Pantallas pequeÃ±as (mÃ³viles) */
@media (max-width: 480px) {
  .grid {
    grid-template-columns: repeat(2, 1fr); /* 2 columnas */
  }
}

/* Pantallas muy pequeÃ±as */
@media (max-width: 360px) {
  .grid {
    grid-template-columns: 1fr; /* 1 columna */
  }
}

.card{background:#fff;border-radius:10px;padding:12px;box-shadow:0 6px 18px rgba(12,20,30,.06);display:flex;gap:12px;align-items:flex-start;flex-direction:column}
.thumb{width:100%;height:200px;border-radius:8px;overflow:hidden;background:#f0f0f0;display:flex;align-items:center;justify-content:center}
.thumb img{width:100%;height:100%;object-fit:cover}
.meta{flex:1;width:100%}
.title{font-weight:700;margin-bottom:6px}
.price{color:var(--accent);font-weight:700;margin-bottom:8px}
.provider{background:#eef5ff;color:var(--accent);padding:4px 8px;border-radius:999px;font-size:12px;display:inline-block}
.footer-actions{display:flex;gap:8px;align-items:center;margin-top:8px;flex-wrap:wrap}
.btn{background:var(--accent);color:white;padding:8px 10px;border-radius:8px;text-decoration:none;cursor:pointer;border:none}
.small{font-size:13px;color:var(--muted)}
.pager{margin-top:18px;display:flex;gap:8px;align-items:center;justify-content:center}

/* Carrito */
#carrito{position:fixed;right:0;top:0;width:350px;height:100%;background:#fff;box-shadow:-2px 0 8px rgba(0,0,0,.1);padding:18px;overflow-y:auto;transition:transform .3s ease;transform:translateX(100%);}
#carrito.open{transform:translateX(0);}
#carrito h2{margin-top:0}
.cart-item{display:flex;gap:8px;align-items:center;margin-bottom:12px;flex-wrap:wrap;border-bottom:1px solid #eee;padding-bottom:8px}
.cart-thumb{width:60px;height:60px;flex-shrink:0;overflow:hidden;border-radius:6px;background:#f0f0f0}
.cart-thumb img{width:100%;height:100%;object-fit:cover}
.cart-info{flex:1}
.cart-info .title{margin:0;font-weight:600;font-size:14px}
.cart-info .price{color:var(--accent);margin:2px 0;font-size:13px}
.cart-remove{cursor:pointer;font-size:12px;color:red}
#toggleCart{position:fixed;right:10px;bottom:10px;background:var(--accent);color:#fff;padding:12px 16px;border-radius:50px;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,.2)}
</style>
</head>
<body>

<header>
  <h1>Buscador Ultra â€” Multi-proveedor</h1>

  <div class="searchbar">
    <input id="q" type="search" placeholder="Buscar producto (ej: 'anillo cuarzo rosa')">
    <div class="controls">
      <select id="proveedorSelect"><option value="">Todos los proveedores</option></select>
      <input id="minPrice" type="number" placeholder="Min $" style="width:100px">
      <input id="maxPrice" type="number" placeholder="Max $" style="width:100px">
      <select id="sort"><option value="relevance">MÃ¡s relevante</option><option value="price_asc">Precio â†‘</option><option value="price_desc">Precio â†“</option></select>
      <button id="buscarBtn" class="btn">Buscar</button>
      <input type="file" id="imagenInput" accept="image/*">
      <button id="btnBuscar">Buscar coincidencias</button>
      
      <pre id="resultado"></pre>

    </div>
  </div>
</header>

<main>
  <div id="stats" class="small" style="margin-bottom:10px"></div>
  <div id="resultados" class="grid"></div>
  <!-- div para mostrar resultados de bÃºsqueda por imagen -->
  <div id="resultados-img" style="margin-top:20px;"></div>
  <div class="pager">
    <button id="prevBtn">Anterior</button>
    <div id="pageInfo"></div>
    <button id="nextBtn">Siguiente</button>
  </div>
</main>

<!-- Carrito -->
<div id="carrito">
  <h2>ðŸ›’ Carrito de Compras</h2>
  <div id="cartContent"></div>
</div>
<div id="toggleCart">ðŸ›’</div>

<script>
const API_BASE = "/api";
let page = 1;
let perPage = 24;
let lastQuery = "";
let carrito = JSON.parse(localStorage.getItem("carritoMega") || "{}");
let relojInterval = null;
let segundosImagen = 0;

function iniciarRelojImagen() {
  segundosImagen = 0;
  document.getElementById("stats").textContent = "ðŸ•’ Buscando por imagen... 0s";

  relojInterval = setInterval(() => {
    segundosImagen++;
    document.getElementById("stats").textContent =
      `ðŸ•’ Buscando por imagen... ${segundosImagen}s`;
  }, 1000);
}

function detenerRelojImagen() {
  clearInterval(relojInterval);
  relojInterval = null;
}

// Escapar HTML
function escapeHTML(str){ 
  return str ? str.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;') : ''; 
}

// Guardar carrito
function guardarCarrito(){ 
  localStorage.setItem("carritoMega", JSON.stringify(carrito));
  renderCarrito();
}

// Renderizar carrito
function renderCarrito(){
  const cont = document.getElementById("cartContent");
  cont.innerHTML = "";
  const proveedores = Object.keys(carrito);
  if(proveedores.length===0){ 
    cont.innerHTML="<p>El carrito estÃ¡ vacÃ­o</p>"; 
    return; 
  }

  proveedores.forEach(prov=>{
    const provDiv = document.createElement("div");
    provDiv.innerHTML = `<h3>${escapeHTML(prov)}</h3>`;
    carrito[prov].forEach((item,index)=>{
      const div = document.createElement("div");
      div.className="cart-item";
      div.innerHTML=`
        <div class="cart-thumb"><img src="${escapeHTML(item.imagen)||'https://via.placeholder.com/60'}"></div>
        <div class="cart-info">
          <p class="title">${escapeHTML(item.titulo)}</p>
          <p class="price">${escapeHTML(item.precio)}</p>
        </div>
        <div class="cart-remove" data-prov="${escapeHTML(prov)}" data-idx="${index}">Eliminar</div>
      `;
      provDiv.appendChild(div);
    });
    cont.appendChild(provDiv);
  });

  // botones eliminar
  cont.querySelectorAll(".cart-remove").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const prov = btn.dataset.prov;
      const idx = parseInt(btn.dataset.idx,10);
      carrito[prov].splice(idx,1);
      if(carrito[prov].length===0) delete carrito[prov];
      guardarCarrito();
    });
  });
}

// Cargar proveedores
async function cargarProveedores(){
  try{
    const res = await fetch(API_BASE + "/proveedores");
    const provs = await res.json();
    const sel = document.getElementById("proveedorSelect");
    provs.forEach(p=>{
      const o = document.createElement("option");
      o.value=p; o.textContent=p;
      sel.appendChild(o);
    });
  }catch(err){
    console.error("Error cargando proveedores:",err);
  }
}

// Buscar productos normales
async function buscar(resetPage = true){
  if(resetPage) page=1;
  const q = document.getElementById("q").value.trim();
  lastQuery = q;
  const proveedor = document.getElementById("proveedorSelect").value;
  const minPrice = document.getElementById("minPrice").value;
  const maxPrice = document.getElementById("maxPrice").value;
  const sort = document.getElementById("sort").value;

  const params = new URLSearchParams();
  if(q) params.set("q",q);
  if(proveedor) params.set("proveedor",proveedor);
  if(minPrice) params.set("minPrice",minPrice);
  if(maxPrice) params.set("maxPrice",maxPrice);
  if(sort) params.set("sort",sort);
  params.set("page",page);
  params.set("perPage",perPage);

  document.getElementById("stats").textContent="ðŸ”Ž Buscando...";
  try{
    const res = await fetch(API_BASE+"/buscar?"+params.toString());
    const data = await res.json();

    const cont = document.getElementById("resultados");
    cont.innerHTML="";
    document.getElementById("stats").textContent=`Resultados: ${data.total} â€” PÃ¡gina ${data.page}`;

    data.results.forEach(item=>{
      const div = document.createElement("div");
      div.className="card";
      div.innerHTML=`
        <div class="thumb">
          <img
            src="${escapeHTML(item.imagenCloud || item.imagen)}"
            class="img-busqueda"
            data-img="${escapeHTML(item.imagenCloud || item.imagen)}"
            alt="${escapeHTML(item.titulo)}"
          >
        </div>
  
        <div class="meta">
          <div class="title">${escapeHTML(item.titulo)}</div>
          <div class="price">${escapeHTML(item.precio)||""}</div>
          <div class="small">Proveedor: <span class="provider">${escapeHTML(item.proveedor)}</span></div>
          <div class="footer-actions">
            <a class="btn" href="${escapeHTML(item.url)}" target="_blank">Ir al producto</a>
            <button class="btn addCartBtn">Agregar al carrito</button>
            <div class="small" style="margin-left:auto">Score: ${(item.score===undefined)?"-":item.score.toFixed(3)}</div>
          </div>
        </div>
      `;
      cont.appendChild(div);

      div.querySelector(".addCartBtn").addEventListener("click", ()=>{
        if(!carrito[item.proveedor]) carrito[item.proveedor]=[];
        carrito[item.proveedor].push({
          titulo: item.titulo,
          precio: item.precio,
          imagen: item.imagenCloud || item.imagen,
          url: item.url
        });
        guardarCarrito();
      });
    });

    document.getElementById("pageInfo").textContent=`PÃ¡gina ${data.page} / ${Math.ceil(data.total/data.perPage)||1}`;
  }catch(err){
    console.error("Error buscando productos:",err);
    document.getElementById("stats").textContent="âŒ Error al buscar productos";
  }
}

// Mostrar resultados de bÃºsqueda por imagen
function mostrarResultadosImagen(resultados) {
  const cont = document.getElementById("resultados");
  cont.innerHTML = ""; // limpiar contenedor
  const placeholder = "https://dummyimage.com/300x300/cccccc/000000&text=No+Image";

  resultados.forEach(item => {
    const imgSrc = item.imagenCloud || item.imagen || placeholder;

    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <div class="thumb">
        <img src="${escapeHTML(imgSrc)}" onerror="this.src='${placeholder}'">
      </div>
      <div class="meta">
        <div class="title">${escapeHTML(item.titulo)}</div>
        <div class="price">${escapeHTML(item.precio) || ""}</div>
        <div class="small">Proveedor: <span class="provider">${escapeHTML(item.proveedor)}</span></div>
        <div class="footer-actions">
          <a class="btn" href="${escapeHTML(item.url)}" target="_blank">Ir al producto</a>
          <button class="btn addCartBtn">Agregar al carrito</button>
        </div>
      </div>
    `;
    cont.appendChild(div);

    // Agregar al carrito
    div.querySelector(".addCartBtn").addEventListener("click", () => {
      if (!carrito[item.proveedor]) carrito[item.proveedor] = [];
      carrito[item.proveedor].push({
        titulo: item.titulo,
        precio: item.precio,
        imagen: imgSrc,
        url: item.url
      });
      guardarCarrito();
    });
  });
}

// Buscar por imagen (click o input file)
async function buscarPorImagen(imagenBlob) {
  iniciarRelojImagen();

  try {
    const formData = new FormData();
    formData.append("imagen", imagenBlob, "busqueda.jpg");

    const res = await fetch("/api/buscarPorImagen", { method: "POST", body: formData });

    if (!res.ok) {
      const txt = await res.text();
      detenerRelojImagen();
      document.getElementById("stats").textContent = txt;
      return;
    }

    const data = await res.json();
    detenerRelojImagen();

    if (data.ok && data.resultados.length) {
      mostrarResultadosImagen(data.resultados);
      document.getElementById("stats").textContent =
        `ðŸ” Resultados: ${data.resultados.length} â€” â± ${segundosImagen}s`;
    } else {
      document.getElementById("stats").textContent = "âš ï¸ No se encontraron resultados";
    }
  } catch (err) {
    detenerRelojImagen();
    document.getElementById("stats").textContent = "âŒ Error al buscar por imagen";
  }
}

// Listener click en imÃ¡genes
document.addEventListener("click", async (e) => {
  if (!e.target.classList.contains("img-busqueda")) return;
  const imagenUrl = e.target.dataset.img || e.target.src;
  if (!imagenUrl) return;

  const imgRes = await fetch(imagenUrl);
  const blob = await imgRes.blob();
  await buscarPorImagen(blob);
});

// Listener input file
document.getElementById("btnBuscar").addEventListener("click", async () => {
  const fileInput = document.getElementById("imagenInput");
  if (!fileInput.files.length) return alert("SeleccionÃ¡ una imagen primero");
  await buscarPorImagen(fileInput.files[0]);
});

// Botones de bÃºsqueda normal
document.getElementById("buscarBtn").addEventListener("click", ()=>buscar(true));
document.getElementById("q").addEventListener("keydown", e=>{ if(e.key==='Enter') buscar(true); });
document.getElementById("prevBtn").addEventListener("click", ()=>{ if(page>1){ page--; buscar(false);} });
document.getElementById("nextBtn").addEventListener("click", ()=>{ page++; buscar(false);} );

// Toggle carrito
document.getElementById("toggleCart").addEventListener("click", ()=>{ document.getElementById("carrito").classList.toggle("open"); });

(async ()=>{
  await cargarProveedores();
  buscar(true);
  renderCarrito();
})();
</script>

</body>
</html>
